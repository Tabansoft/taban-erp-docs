# مدیریت انتقال وجوه داخلی (Internal Fund Transfers)

## ۱. مقدمه: گردش خون در رگ‌های سازمان

در سیستم ERP تابان، ماژول **«انتقال داخلی»** مخصوص ثبت جابجایی پول بین منابع داخلی شرکت است.
نکته کلیدی که این فرم را از «دریافت» و «پرداخت» متمایز می‌کند، **عدم وجود طرف حساب تجاری (مشتری/تأمین‌کننده)** است. در اینجا پول از جیب چپ شرکت به جیب راست شرکت می‌رود.

**کاربردهای اصلی:**

1.  **شارژ تنخواه:** انتقال پول از حساب اصلی شرکت به کارت/صندوق تنخواه‌گردان.
2.  **تخلیه صندوق فروش:** واریز وجه نقد جمع شده در دخل فروشگاه به حساب بانکی (EOD Deposit).
3.  **مدیریت نقدینگی:** جابجایی پول بین حساب‌های بانکی (مثلاً از حساب جاری به حساب پس‌انداز برای دریافت سود).
4.  **تسعیر ارز (صرافی داخلی):** تبدیل موجودی دلاری به ریالی (فروش ارز به خود).

-----

## ۲. ساختار فرم عملیاتی: سند انتقال (Transfer Document)

**مسیر دسترسی:** `خزانه‌داری > عملیات > انتقال وجه داخلی`

این فرم ساختاری متفاوت از دریافت/پرداخت دارد و بر پایه منطق **«مبدأ (From)»** و **«مقصد (To)»** بنا شده است.

### بخش اول: اطلاعات سربرگ (Header)

| عنوان فیلد | نام فنی | نوع داده | الزامی | راهنمای تکمیل |
| :--- | :--- | :--- | :--- | :--- |
| **شماره سند** | `DocNum` | String | بله | تولید خودکار (مثلاً `TRF-1403-050`). |
| **تاریخ انتقال** | `DocDate` | Date | بله | تاریخ واقعی عملیات بانکی/صندوق. |
| **مسئول پیگیری** | `AgentID` | FK | خیر | نام شخصی که مأمور انتقال وجه بوده (مثلاً تحصیلدار یا تنخواه‌گردان). |
| **شرح سند** | `Description` | String | بله | توضیحات (مثلاً: شارژ تنخواه واحد بازرگانی). |
| **وضعیت** | `Status` | Enum | - | پیش‌نویس / نهایی شده. |

---

### بخش دوم: اطلاعات مبدأ (Source - برداشت)

**سوال:** پول از کجا خارج شده است؟

| فیلد | توضیحات و منطق |
| :--- | :--- |
| **نوع منبع** | انتخاب بین: `حساب بانکی` یا `صندوق نقد`. |
| **نام منبع** | انتخاب حساب/صندوق خاص (مثلاً: بانک ملت - جاری). |
| **مبلغ خروجی** | مبلغی که دقیقاً از حساب مبدأ کسر شده است. |
| **ارز مبدأ** | ارز حساب مبدأ (مثلاً یورو). |
| **شماره پیگیری** | شماره چک صادر شده یا شماره برداشت (اگر حواله بوده). |

---

### بخش سوم: اطلاعات مقصد (Destination - واریز)

**سوال:** پول به کجا وارد شده است؟

| فیلد | توضیحات و منطق |
| :--- | :--- |
| **نوع منبع** | انتخاب بین: `حساب بانکی` یا `صندوق نقد`. |
| **نام منبع** | انتخاب حساب/صندوق خاص (مثلاً: صندوق تنخواه ۱). |
| **مبلغ ورودی** | مبلغی که دقیقاً به حساب مقصد نشسته است. |
| **ارز مقصد** | ارز حساب مقصد (مثلاً ریال). |
| **نرخ تبدیل** | `ExchangeRate`: اگر ارز مبدأ و مقصد متفاوت است، نرخ تبدیل باید وارد شود. |

---

### بخش چهارم: هزینه‌های انتقال (Transaction Costs) - **(نکته حیاتی)**

در بسیاری از انتقالات بانکی، مبلغی که از مبدأ کم می‌شود با مبلغی که به مقصد می‌رسد برابر نیست (به دلیل کارمزد).
این بخش برای تراز کردن سند ضروری است.

| فیلد | توضیحات و منطق |
| :--- | :--- |
| **کارمزد بانکی** | `BankFee`: مبلغی که بانک بابت انجام تراکنش کسر کرده است. |
| **شرح هزینه** | توضیحات (مثلاً: کارمزد پایا / کارمزد تبدیل ارز). |
| **مرکز هزینه** | (اختیاری) اگر بخواهیم هزینه کارمزد را به واحد خاصی تخصیص دهیم. |

-----

## ۳. سناریوهای عملیاتی و اسناد حسابداری (Scenarios & GL)

این فرم باید ۳ سناریوی پیچیده حسابداری را به صورت اتوماتیک مدیریت کند.

### سناریو ۱: شارژ تنخواه (بانک به صندوق) - با کارمزد

**داستان:** ۵۰ میلیون تومان از بانک ملت به کارت تنخواه‌گردان (صندوق) واریز می‌کنیم. بانک ۵,۰۰۰ تومان کارمزد کم می‌کند.

* **برداشت از بانک:** ۵۰,۰۰۵,۰۰۰ ریال.
* **واریز به صندوق:** ۵۰,۰۰۰,۰۰۰ ریال.

**سند حسابداری اتوماتیک:**

| ردیف | نام حساب (GL) | بدهکار (Dr) | بستانکار (Cr) | شرح |
| :--- | :--- | :--- | :--- | :--- |
| ۱ | صندوق تنخواه گردان | ۵۰,۰۰۰,۰۰۰ | | افزایش موجودی صندوق |
| ۲ | هزینه کارمزد بانکی | ۵,۰۰۰ | | شناسایی هزینه |
| ۳ | موجودی بانک ملت | | ۵۰,۰۰۵,۰۰۰ | کاهش موجودی بانک (اصل + کارمزد) |

---

### سناریو ۲: تخلیه صندوق فروش (صندوق به بانک) - بدون کارمزد
**داستان:** پایان شب، مبلغ ۱۲ میلیون پول نقد از دخل فروشگاه به حساب شبانه بانک واریز می‌شود.

**سند حسابداری اتوماتیک:**

| ردیف | نام حساب (GL) | بدهکار (Dr) | بستانکار (Cr) | شرح |
| :--- | :--- | :--- | :--- | :--- |
| ۱ | موجودی بانک | ۱۲,۰۰۰,۰۰۰ | | افزایش بانک |
| ۲ | صندوق فروشگاه | | ۱۲,۰۰۰,۰۰۰ | صفر شدن دخل |

---

### سناریو ۳: تبدیل ارز (بانک ارزی به بانک ریالی)
**داستان:** فروش ۱,۰۰۰ دلار از حساب ارزی و واریز معادل ریالی به حساب جاری.

* **خروجی:** ۱,۰۰۰ دلار (نرخ دفتری سیستم: ۵۰,۰۰۰ تومان = ۵۰ میلیون ارزش دفتری).
* **ورودی:** ۵۵,۰۰۰,۰۰۰ تومان (نرخ فروش صرافی: ۵۵,۰۰۰ تومان).

**سند حسابداری اتوماتیک (با شناسایی سود):**

| ردیف | نام حساب (GL) | بدهکار (Dr) | بستانکار (Cr) | شرح |
| :--- | :--- | :--- | :--- | :--- |
| ۱ | بانک ریالی | ۵۵,۰۰۰,۰۰۰ | | پول نقد حاصل از فروش |
| ۲ | بانک ارزی (دلاری) | | ۵۰,۰۰۰,۰۰۰ | خروج دلار به نرخ دفتری |
| ۳ | **سود ناشی از تسعیر ارز** | | ۵,۰۰۰,۰۰۰ | سود حاصل از فروش ارز |

-----

## ۴. کنترل‌های امنیتی و سیستمی (Validations)

1.  **معادله تراز سند:**
    `مبلغ خروجی مبدأ` **منهای** `کارمزد` **مساوی است با** `مبلغ ورودی مقصد`.
    *(در حالت ارزی، این تراز با احتساب نرخ تبدیل سنجیده می‌شود).*

2.  **کنترل موجودی لحظه‌ای:**
    * اگر مبدأ **«صندوق»** باشد، سیستم چک می‌کند موجودی نقد کافی باشد. (نمی‌توان از صندوق خالی پول به بانک برد).
    * اگر مبدأ **«بانک»** باشد، بسته به تنظیمات (Allow Overdraft) ممکن است اجازه منفی شدن بدهد یا ندهد.

3.  **جلوگیری از انتقال دوری (Loop Check):**
    * مبدأ و مقصد نمی‌توانند یکسان باشند (مثلاً از بانک ملت به بانک ملت). برای اصلاح حساب باید از سند اصلاحی استفاده کرد، نه سند انتقال.

-----

## ۵. بخش پرسش‌های متداول (FAQ)

**س: اگر بخواهم از حساب شرکت پول بردارم و به حساب "شخصی" مدیرعامل بریزم، آیا سند انتقال بزنم؟**
پ: **خیر!** حساب شخصی مدیرعامل، یک حساب "بیرونی" محسوب می‌شود (طرف حساب: جاری شرکا). باید از **«سند پرداخت»** استفاده کنید. سند انتقال فقط برای حساب‌هایی است که در سیستم ماژول خزانه به نام خودِ شرکت تعریف شده‌اند.

**س: در جابجایی چک بین صندوق‌ها (مثلاً از شعبه ۱ به دفتر مرکزی) از چه فرمی استفاده کنیم؟**
پ: برای جابجایی فیزیک چک، از این فرم استفاده **نمی‌شود**. باید از منوی `مدیریت چک > عملیات چک > جابجایی بین صندوق‌ها` استفاده کنید. فرم "سند انتقال" فقط مخصوص جابجایی **وجه نقد و موجودی بانکی** است.

**س: اگر کارمزد بانک در مقصد کسر شود چه؟ (مثلاً ۱۰۰ تا فرستادیم، ۹۹ تا رسید)**
پ: در فرم انتقال، شما مبلغ خروجی را ۱۰۰ و مبلغ ورودی را ۹۹ وارد می‌کنید. سیستم اختلاف (۱ واحد) را در فیلد کارمزد قرار می‌دهد و سند را تراز می‌کند.

**س: آیا می‌توانم برای انتقال وجه چک بکشم؟**
پ: بله. در بخش "اطلاعات مبدأ"، اگر نوع منبع حساب بانکی باشد، می‌توانید شماره چک را وارد کنید (به عنوان چک در وجه خودمان/حامل). سیستم این چک را در ماژول چک ثبت نمی‌کند، بلکه مستقیماً تراکنش مالی آن را انجام می‌دهد.