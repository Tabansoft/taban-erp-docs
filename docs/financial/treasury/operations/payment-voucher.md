# مستندات جامع فنی: ماژول مدیریت پرداخت‌ها (Payables Management)

## ۱. مقدمه: فلسفه و معماری کنترل نقدینگی

در سیستم ERP تابان، ماژول **«مدیریت پرداخت‌ها»** یک سیستم کنترل مرکزی برای خروج نقدینگی است. برخلاف سیستم‌های سنتی که پرداخت را صرفاً "صدور چک" می‌دانند، در تابان این یک فرآیند ۳ مرحله‌ای است که تضمین می‌کند هیچ پولی خارج نمی‌شود مگر اینکه:

1.  **تعهد شناسایی شده باشد** (تخصیص به بدهی).
2.  **حقوق قانونی و قراردادی کسر شده باشد** (خالص‌سازی).
3.  **ابزار پرداخت معتبر باشد** (اجرا).

-----

## ۲. انواع پرداخت (Payment Types)

فیلد `PaymentType` تعیین می‌کند فرم چه رفتاری داشته باشد و کدام حساب‌های معین درگیر شوند:

| نوع پرداخت | نام فنی | کاربرد و منطق رفتاری |
| :--- | :--- | :--- |
| **۱. پرداخت به تأمین‌کننده** | `VendorPayment` | **(استاندارد)** پرداخت بابت فاکتورهای خرید، صورت‌وضعیت‌ها یا علی‌الحساب تجاری. <br> *الزامات:* انتخاب «تأمین‌کننده» اجباری است. تب‌های «تخصیص» و «کسورات» فعال هستند. |
| **۲. پیش‌پرداخت سفارش** | `Prepayment` | پرداخت قبل از دریافت کالا/خدمت. <br> *الزامات:* مستقیماً به «سفارش خرید» (PO) لینک می‌شود. تب تخصیص غیرفعال (چون فاکتوری نیست) اما تب کسورات فعال است. |
| **۳. هزینه مستقیم** | `DirectExpense` | پرداخت‌های بدون فاکتور خرید (مثل هزینه پیک، شارژ ساختمان، خرید ملزومات جزئی). <br> *الزامات:* مستقیماً به یک «حساب هزینه» (Expense GL) لینک می‌شود. |
| **۴. حقوق و دستمزد** | `SalaryPayment` | پرداخت حقوق کارکنان (معمولاً از طریق «ویزارد پرداخت گروهی» انجام می‌شود). |
| **۵. پرداخت‌های قانونی** | `TaxPayment` | پرداخت بدهی‌های کسر شده (بیمه، مالیات) به سازمان‌های دولتی. <br> *الزامات:* طرف حساب حتماً باید یک ارگان دولتی باشد. |

-----

## ۳. اسناد مرجع قابل تخصیص (Allocation Sources)

در تب تخصیص، کاربر می‌تواند پرداخت را به اسناد زیر متصل کند:

| نوع سند مرجع | کاربرد | مثال |
| :--- | :--- | :--- |
| **۱. فاکتور خرید (Purchase Invoice)** | تسویه بدهی ناشی از خرید کالا/خدمات. | فاکتور خرید ۱۰۰ تن ورق فولادی. |
| **۲. صورت‌وضعیت (Contractor Statement)** | تسویه خدمات پیمانکاری (عمرانی/فنی). | صورت‌وضعیت شماره ۳ برق‌کشی ساختمان. |
| **۳. سند مانده اول دوره (Opening Balance)** | تسویه بدهی‌های سنواتی (قبل از استقرار سیستم). | مانده حساب دفتری سال گذشته. |
| **۴. اعلامیه بدهکار (Debit Note)** | بدهی‌های غیرتجاری یا اصلاحی. | جریمه دیرکرد که توافق کردیم بپردازیم. |
| **۵. سفارش خرید (Purchase Order)** | فقط برای **پیش‌پرداخت**. | پرداخت ۳۰٪ مبلغ قرارداد قبل از حمل کالا. |
| **۶. گزارش تنخواه (Expense Report)** | بازپرداخت هزینه‌های انجام شده توسط پرسنل. | تسویه هزینه مأموریت مدیر فروش. |

-----

## ۴. فرم عملیاتی: سند پرداخت (Payment Document)

**مسیر دسترسی:** `خزانه‌داری > عملیات پرداخت > سند پرداخت جدید`

### بخش اول: اطلاعات سربرگ (Header)

| عنوان فیلد | نام فنی | الزامی | راهنمای تکمیل و منطق هوشمند |
| :--- | :--- | :--- | :--- |
| **شماره سند** | `DocNum` | بله | تولید خودکار (مثلاً `PAY-1403-0150`). |
| **بنگاه اقتصادی** | `LegalEntity` | بله | پرداخت از حساب کدام شرکت انجام می‌شود؟ |
| **دریافت‌کننده** | `PayeeID` | بله | نام تأمین‌کننده، پیمانکار، کارمند یا سازمان. |
| **تاریخ پرداخت** | `DocDate` | بله | تاریخ صدور چک یا کسر وجه. |
| **ارز / نرخ ارز** | `ExRate` | بله | نرخ تبدیل در لحظه پرداخت (جهت محاسبه سود/زیان تسعیر ارز). |
| **مبلغ قابل پرداخت** | `TotalNet` | **بله** | **(فیلد هوشمند/دوگانه):** <br> ۱. **حالت محاسباتی (پیش‌فرض):** این فیلد قفل است. سیستم نتیجه `(جمع تخصیص - جمع کسورات)` را نمایش می‌دهد. <br> ۲. **حالت دستی (علی‌الحساب/جزئی):** با زدن تیک "ورود دستی"، کاربر مبلغ را تایپ می‌کند (مثلاً ۵۰ میلیون) و سقف تخصیص محدود به این عدد می‌شود. |

-----

### تب ۱: تخصیص (Allocation)

در این تب، سیستم لیست بدهی‌های بازِ طرف حساب را نمایش می‌دهد.
\<span style="color:green"\>**نکته مهم (ارزش افزوده):** مبلغ بدهی نمایش داده شده در اینجا، مبلغ **کل فاکتور** (شامل اصل جنس + ارزش افزوده) است. ارزش افزوده قبلاً در فاکتور خرید شناسایی شده و اینجا بخشی از بدهی عادی است.\</span\>

| انتخاب | نوع سند | شماره مرجع | تاریخ | مبلغ کل بدهی | مانده باز | مبلغ تخصیص (Gross) |
| :---: | :--- | :--- | :--- | :--- | :--- | :--- |
| ☑️ | صورت‌وضعیت | ST-101 | 1403/04/01 | 100,000,000 | 100,000,000 | **100,000,000** |
| ☑️ | فاکتور خرید | PUR-505 | 1403/04/15 | 20,000,000 | 20,000,000 | **20,000,000** |

  * **جمع ناخالص تخصیص:** ۱۲۰,۰۰۰,۰۰۰ ریال.

-----

### تب ۲: کسورات (Deductions)

**هدف:** نمایش مبالغی که از پول پیمانکار کسر شده و نزد ما به امانت می‌ماند (بیمه، مالیات تکلیفی، حسن انجام کار).
\<span style="color:red"\>**قانون:**\</span\> این تب برای خزانه‌دار **فقط خواندنی (Read-Only)** است تا در محاسبات قانونی دخالت نکند. ارقام از "قرارداد" یا "درخواست پرداخت" فراخوانی می‌شوند.

| ردیف | نوع کسورات | مرتبط با سند | مبلغ کسر شده | شرح محاسباتی |
| :--- | :--- | :--- | :--- | :--- |
| ۱ | سپرده بیمه | ST-101 | 16,670,000 | ۱۶.۶۷٪ ماده ۳۸ |
| ۲ | مالیات تکلیفی | ST-101 | 5,000,000 | ۵٪ ماده ۱۰۴ |
| ۳ | حسن انجام کار | ST-101 | 10,000,000 | ۱۰٪ نگهداشت |
| ۴ | -- | PUR-505 | 0 | خرید کالا کسورات ندارد |

  * **جمع کسورات:** ۳۱,۶۷۰,۰۰۰ ریال.
  * **خالص قابل پرداخت:** `۱۲۰,۰۰۰,۰۰۰ - ۳۱,۶۷۰,۰۰۰ = ۸۸,۳۳۰,۰۰۰ ریال`.

-----

### تب ۳: روش‌های پرداخت (Payment Lines) - "اجرا"

خزانه‌دار موظف است دقیقاً مبلغ **۸۸,۳۳۰,۰۰۰ ریال** (مبلغ خالص) را با استفاده از ترکیب روش‌های زیر پرداخت کند.

#### روش الف: صدور چک (Check Issuance)

| فیلد | توضیحات و منطق |
| :--- | :--- |
| **حساب بانکی** | انتخاب حساب جاری (مثلاً بانک ملت). |
| **دسته چک** | انتخاب دسته چک مربوطه. |
| **شماره سریال** | **انتخاب از لیست:** فقط چک‌های "سفید/خام". تایپ دستی ممنوع. |
| **مبلغ چک** | مبلغ روی برگه چک. |
| **تاریخ سررسید** | تاریخ نقد شدن. |
| **در وجه** | نام گیرنده (پیش‌فرض: نام تأمین‌کننده، قابل ویرایش). |

#### روش ب: حواله بانکی (Wire Transfer)

| فیلد | توضیحات و منطق |
| :--- | :--- |
| **حساب مبدأ** | حساب بانکی شرکت. |
| **حساب مقصد** | \<span style="color:red"\>**امنیت:**\</span\> فقط انتخاب از لیست حساب‌های تایید شده در پروفایل تأمین‌کننده (جلوگیری از تغییر شبا). |
| **شماره پیگیری** | Trace No (کد رهگیری بانکی). |
| **مبلغ حواله** | مبلغی که به حساب طرف نشسته است. |
| **کارمزد بانکی** | `BankChargeAmount`: مبلغی که بانک بابت کارمزد کسر کرده (جداگانه سند می‌خورد). |

#### روش ج: پرداخت نقدی (Cash Payment)

*(مخصوص هزینه‌های خرد، پیک، تنخواه)*

| فیلد | توضیحات و منطق |
| :--- | :--- |
| **صندوق مبدأ** | انتخاب صندوق نقد (مثلاً: صندوق تنخواه گردان، گاوصندوق اصلی). |
| **مبلغ** | مبلغ پرداختی به ریال. |
| **تحویل گیرنده** | نام شخصی که پول نقد را فیزیکی تحویل گرفته است (برای اخذ امضا). |
| **شرح ردیف** | توضیحات تکمیلی (مثلاً: بابت خرید نهار پرسنل). |

#### روش د: خرج چک (Endorsement)

*(استفاده از چک مشتری برای پرداخت بدهی)*

| فیلد | توضیحات و منطق |
| :--- | :--- |
| **انتخاب چک** | دکمه‌ای که لیست **"چک‌های موجود در صندوق"** (دریافتی از مشتریان) را باز می‌کند. |
| **مبلغ** | غیرقابل ویرایش (برابر با مبلغ چک انتخابی). |
| **عملیات** | انتقال مالکیت چک به تأمین‌کننده. |

-----

## ۵. کنترل‌های امنیتی و هوشمند (Validations)

1.  **معادله تراز سند:**
    `مبلغ ناخالص تخصیص` - `کسورات` = `مبلغ خالص هدر` = `جمع (چک + نقد + حواله + خرج چک)`.
    *(حتی ۱ ریال اختلاف مانع ثبت می‌شود).*

2.  **قفل حساب مقصد (IBAN Lock):**
    در روش حواله، امکان تایپ دستی شماره شبا وجود ندارد.

3.  **جلوگیری از پرداخت تکراری:**

      * سطح ۱: فاکتور انتخاب شده نباید در سند دیگری استفاده شده باشد.
      * سطح ۲: هشدار اگر مبلغ و گیرنده مشابه پرداخت‌های ۷۲ ساعت گذشته باشد.

4.  **کنترل موجودی لحظه‌ای:**

      * **صندوق:** اگر موجودی نقد کافی نباشد، اجازه ثبت روش "نقد" را نمی‌دهد.
      * **خرج چک:** چک انتخاب شده باید وضعیت "نزد صندوق" داشته باشد.

-----

## ۶. اسناد حسابداری اتوماتیک (GL Entries)

سیستم بر اساس مثال عملیاتی بالا، سند زیر را صادر می‌کند:

| ردیف | نام حساب (GL) | بدهکار (Dr) | بستانکار (Cr) | شرح و محاسبات |
| :--- | :--- | :--- | :--- | :--- |
| ۱ | **حساب‌های پرداختنی (شرکت البرز)** | ۱۲۰,۰۰۰,۰۰۰ | | تسویه کامل بدهی ناخالص |
| ۲ | **هزینه کارمزد بانکی** | ۵,۰۰۰ | | کارمزد حواله |
| ۳ | **موجودی بانک ملت** | | ۳۸,۳۳۵,۰۰۰ | اصل حواله + کارمزد |
| ۴ | **اسناد پرداختنی** | | ۵۰,۰۰۰,۰۰۰ | صدور چک |
| ۵ | **بیمه پرداختنی** | | ۱۶,۶۷۰,۰۰۰ | بدهی به تامین اجتماعی |
| ۶ | **مالیات تکلیفی** | | ۵,۰۰۰,۰۰۰ | بدهی به دارایی |
| ۷ | **سپرده حسن انجام کار** | | ۱۰,۰۰۰,۰۰۰ | مبلغ نگهداشت |

-----

## ۷. بخش پرسش‌های متداول (FAQ)

**س: مالیات بر ارزش افزوده (VAT) کجای این جدول است؟**
پ: مبلغ ارزش افزوده قبلاً در "فاکتور خرید" به مبلغ بدهی تأمین‌کننده اضافه شده است. در فرم پرداخت، مبلغی که در تب تخصیص می‌بینید شامل VAT هم هست. بنابراین نیازی به تفکیک یا کسر مجدد آن نیست و کل مبلغ به فروشنده پرداخت می‌شود.

**س: کسورات (بیمه/مالیات) کی پرداخت می‌شوند؟**
پ: در سند پرداخت به پیمانکار، این مبالغ فقط شناسایی (کسر) می‌شوند. پرداخت واقعی به دولت در یک سند جداگانه با نوع `TaxPayment` انجام می‌شود.

**س: آیا خزانه‌دار باید کسورات را محاسبه کند؟**
پ: خیر. تب کسورات برای خزانه‌دار فقط خواندنی است و ارقام آن سیستمی پر می‌شود تا خزانه‌دار فقط مجری پرداخت مبلغ خالص باشد.

**س: اگر بخواهم ۵۰ میلیون بدهم ولی فاکتور ۱۰۰ میلیون است؟ (پرداخت جزئی)**
پ: در هدر سند تیک "ورود دستی" را بزنید و مبلغ ۵۰ میلیون را وارد کنید. سیستم ۵۰ میلیون از بدهی را کسر می‌کند و ۵۰ میلیون دیگر به عنوان "مانده باز" روی فاکتور باقی می‌ماند.

**س: پرداخت هزینه خرد (پیک موتوری) چگونه است؟**
پ: نوع پرداخت را `DirectExpense` انتخاب کنید. در تب حسابداری کد "هزینه پیک" را بزنید و در تب روش پرداخت، "نقد" از "صندوق تنخواه" را انتخاب کنید.