# مدیریت تسویه حساب‌ها (Settlement Workbench)

## ۱. مقدمه: چرا تسویه حساب جدا از دریافت/پرداخت است؟

در سیستم‌های حسابداری ساده، دریافت پول مساوی با تسویه حساب است. اما در واقعیت تجاری، همیشه اینطور نیست.
ممکن است مشتری:
1.  یک چک ۵۰ میلیونی بدهد ولی نگوید بابت کدام فاکتور است (پرداخت علی‌الحساب).
2.  دو فاکتور را با یک چک و یک حواله پرداخت کند (رابطه چند به چند).
3.  مبلغی را پرداخت کند، اما ۱۰۰۰ تومان کمتر واریز کند (نیاز به کسر جزئی).

**میزکار تسویه (Settlement Workbench)** ابزاری است که حسابدار در پایان روز یا هفته به آن مراجعه می‌کند تا «اقلام باز» (Open Items) بدهکار و بستانکار را به هم متصل کرده و پرونده آنها را ببندد.

**اهداف کلیدی:**
* **شفافیت سنی مطالبات (Aging):** تا زمانی که فاکتور تسویه نشود، سیستم آن را به عنوان "بدهی معوق" نشان می‌دهد، حتی اگر مانده کلی حساب مشتری صفر باشد.
* **مدیریت سود و زیان تسعیر ارز:** محاسبه اختلاف نرخ ارز بین زمان صدور فاکتور و زمان دریافت پول.
* **پاکسازی حساب:** حذف اختلافات جزئی (رند کردن مبالغ) برای جلوگیری از باز ماندن فاکتورها بابت مبالغ ناچیز.

-----

## ۲. ساختار فرم میزکار تسویه

**مسیر دسترسی:** `خزانه‌داری > عملیات > تسویه حساب طرف‌های تجاری`

این فرم یک نمای **دو ستونی (Split View)** دارد که تمام اقلام باز یک طرف حساب خاص را نمایش می‌دهد.

### بخش انتخاب (Selection)
در بالای فرم، کاربر فیلترهای اصلی را تعیین می‌کند:
* **طرف حساب:** (مثلاً: شرکت ایران خودرو).
* **نوع طرف حساب:** مشتری / تأمین‌کننده.
* **ارز مبنا:** (مثلاً ریال).

### نمای دو ستونی (The Workbench View)

| ستون سمت راست: بدهکاری‌ها (Debits) | ستون سمت چپ: بستانکاری‌ها (Credits) |
| :--- | :--- |
| **محتوا:** فاکتورهای فروش صادر شده، اسناد برگشت از خرید، سندهای بدهکار دستی. | **محتوا:** رسیدهای دریافت (نقد/چک)، فاکتورهای برگشت از فروش (Credit Note)، پیش‌دریافت‌ها. |
| **داده‌های نمایش داده شده:** شماره فاکتور، تاریخ سررسید، مبلغ کل، **مانده باز**. | **داده‌های نمایش داده شده:** شماره سند دریافت، روش پرداخت، تاریخ، **مانده تخصیص نیافته**. |

-----

## ۳. فرآیند گام‌به‌گام تسویه (Workflow)

### گام اول: انتخاب اقلام (Matching)
حسابدار رکوردها را از دو ستون انتخاب می‌کند.
* از راست: فاکتور `INV-101` (مانده: ۱۰۰ واحد).
* از چپ: سند دریافت `RCT-505` (مانده: ۱۰۰ واحد).

### گام دوم: تحلیل موازنه (Balance Analysis)
در پایین فرم، سیستم وضعیت انتخاب‌های شما را نشان می‌دهد:
* **جمع انتخاب شده بدهکار:** ۱۰۰
* **جمع انتخاب شده بستانکار:** ۱۰۰
* **اختلاف (Difference):** ۰
* --> دکمه **«ثبت تسویه»** سبز می‌شود.

### گام سوم: تسویه جزئی (Partial Settlement)
اگر مبلغ پرداخت کمتر از فاکتور باشد (مثلاً فاکتور ۱۰۰، پرداخت ۷۰):
1.  سیستم اختلاف ۳۰ واحدی را نشان می‌دهد.
2.  اگر دکمه ثبت را بزنید، سیستم دو گزینه می‌دهد:
    * **باقی‌مانده باز بماند (Keep Open):** فاکتور تسویه نمی‌شود، بلکه مانده آن به ۳۰ کاهش می‌یابد. (حالت استاندارد).
    * **رند کردن/تخفیف (Write-off):** اختلاف را به حساب هزینه/تخفیف ببر و فاکتور را کامل ببند.

### گام چهارم: تسویه چند به چند (Many-to-Many)
کاربر می‌تواند ۳ فاکتور کوچک را انتخاب کند و با یک چک بزرگ تسویه کند. سیستم به ترتیب تاریخ (FIFO) یا بر اساس انتخاب کاربر، مبلغ چک را بین فاکتورها پخش می‌کند.

-----

## ۴. سناریوهای پیشرفته و اسناد حسابداری

عملیات تسویه در حالت عادی (وقتی مبالغ برابرند) سند حسابداری تولید نمی‌کند (چون فقط لینک کردن است). اما در ۳ حالت خاص، سیستم **سند اتوماتیک (GL Entry)** صادر می‌کند:

### سناریو ۱: کسر جزئی / رند کردن (Write-off)
**داستان:** فاکتور ۱,۰۰۰,۵۰۰ ریال است. مشتری ۱,۰۰۰,۰۰۰ ریال واریز کرده. حسابدار نمی‌خواهد فاکتور بابت ۵۰۰ ریال باز بماند.
**عملیات:** انتخاب گزینه Write-off برای ۵۰۰ ریال اختلاف.

**سند حسابداری:**
| نام حساب | بدهکار | بستانکار | شرح |
| :--- | :--- | :--- | :--- |
| تخفیفات نقدی / هزینه‌های جذب نشده | ۵۰۰ | | رند کردن فاکتور ۱۰۱ |
| حساب‌های دریافتنی (مشتری) | | ۵۰۰ | بستن مانده فاکتور |

### سناریو ۲: تسعیر ارز (Realized Exchange Gain/Loss) - **بسیار مهم**
**داستان:**
* فاکتور فروش: ۱۰۰ دلار (نرخ زمان صدور: ۵۰,۰۰۰ تومان) -> بدهی مشتری: ۵,۰۰۰,۰۰۰ تومان.
* دریافت وجه: ۱۰۰ دلار (نرخ زمان دریافت: ۵۵,۰۰۰ تومان) -> واریز به بانک: ۵,۵۰۰,۰۰۰ تومان.
* **اختلاف:** ۵۰۰,۰۰۰ تومان سود ناشی از افزایش نرخ ارز.

**عملیات:** هنگام تسویه این دو آیتم ۱۰۰ دلاری، سیستم متوجه اختلاف ریالی می‌شود.

**سند حسابداری:**
| نام حساب | بدهکار | بستانکار | شرح |
| :--- | :--- | :--- | :--- |
| حساب‌های دریافتنی (مشتری) | | ۵,۰۰۰,۰۰۰ | تسویه اصل فاکتور (با نرخ قدیم) |
| بانک (در سند دریافت قبلاً ثبت شده) | (۵,۵۰۰,۰۰۰) | | *(این ردیف قبلاً سند خورده)* |
| **سود تحقق یافته تسعیر ارز** | | ۵۰۰,۰۰۰ | شناسایی سود قطعی |

### سناریو ۳: تهاتر (Contra Settlement)
**داستان:** "شرکت ذوب آهن" هم مشتری ماست (فروشنده آهن) و هم تأمین‌کننده ما (خرید ضایعات). می‌خواهیم فاکتور فروش را با فاکتور خرید تهاتر کنیم.
**عملیات:** انتخاب فاکتور فروش (از ستون بدهکار) و فاکتور خرید (که باید به ستون بستانکار منتقل شود).

**سند حسابداری:**
| نام حساب | بدهکار | بستانکار |
| :--- | :--- | :--- |
| حساب‌های پرداختنی (ذوب آهن) | X | |
| حساب‌های دریافتنی (ذوب آهن) | | X |

-----

## ۵. تسویه اتوماتیک (Auto-Match)

برای شرکت‌هایی با تراکنش بالا، تسویه دستی زمان‌بر است. دکمه **«پیشنهاد تسویه هوشمند»** بر اساس الگوریتم‌های زیر عمل می‌کند:

1.  **تطابق دقیق مبلغ (Exact Match):** سیستم می‌گردد ببیند آیا فاکتور و پرداختی وجود دارند که مبلغشان دقیقاً یکی باشد؟
2.  **تطابق شماره مرجع (Reference Match):** اگر مشتری در فیش واریزی شماره فاکتور را نوشته باشد (و کاربر آن را در فیلد ارجاع سند دریافت وارد کرده باشد)، سیستم آنها را جفت می‌کند.
3.  **روش FIFO (اولین صادره، اولین وارده):** قدیمی‌ترین فاکتورها را با قدیمی‌ترین پرداخت‌های موجود تسویه می‌کند تا زمانی که پول تمام شود.

-----

## ۶. گزارش‌های کلیدی

استفاده صحیح از این ماژول، گزارش‌های حیاتی زیر را تولید می‌کند:

1.  **گزارش سنی مطالبات (Aging Report):**
    * این گزارش نشان می‌دهد هر فاکتور باز، چند روز از سررسیدش گذشته است (۰-۳۰ روز، ۳۰-۶۰ روز، ...). بدون ماژول تسویه، این گزارش غیرممکن است چون سیستم نمی‌داند کدام پول بابت کدام فاکتور بوده.
2.  **صورتحساب باز مشتری (Open Item Statement):**
    * به جای ارسال ریز گردش حساب (که شلوغ و گیج‌کننده است)، لیستی فقط شامل فاکتورهای پرداخت‌نشده برای مشتری ارسال می‌شود.
3.  **تاریخچه تسویه (Settlement History):**
    * این فاکتور خاص، دقیقاً با کدام چک‌ها و در چه تاریخ‌هایی تسویه شده است؟

-----

## ۷. سوالات متداول (FAQ)

**س: اگر اشتباه تسویه کردم چه می‌شود؟**
پ: نگران نباشید. می‌توانید به تب "تاریخچه تسویه" بروید، تسویه مورد نظر را انتخاب و دکمه **«لغو تسویه» (Un-match)** را بزنید.
* لینک بین فاکتور و پرداخت شکسته می‌شود.
* هر دو دوباره به حالت "باز" برمی‌گردند.
* اگر سند حسابداری (سود و زیان یا تخفیف) صادر شده باشد، سیستم سند معکوس می‌زند.

**س: آیا می‌توانم پیش‌دریافت را به فاکتور وصل کنم؟**
پ: بله، دقیقاً کار این فرم همین است. پیش‌دریافت (که یک قلم بستانکار باز است) را انتخاب کنید و به فاکتور نهایی (قلم بدهکار) وصل کنید.

**س: آیا تسویه حساب با اسناد "پیش‌نویس" ممکن است؟**
پ: خیر. فقط اسنادی که وضعیت آنها **"نهایی / ثبت شده" (Posted)** باشد در این میزکار نمایش داده می‌شوند.