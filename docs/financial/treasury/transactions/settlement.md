# مفهوم و فرم: تسویه حساب (Settlement / Clearing)

---

## ۱. مفهوم

تسویه حساب، فرآیند حیاتی «اتصال» آیتم‌های بستانکار (مانند پرداخت‌ها، پیش‌پرداخت‌ها، اعتبارات) به آیتم‌های بدهکار (مانند فاکتورها) در حساب یک طرف حساب (مشتری یا تأمین‌کننده) است.

* **هدف:** صفر کردن مانده حساب آیتم‌های باز و تعیین وضعیت «تسویه شده» برای فاکتورها و پرداخت‌ها.
* **نیاز به تسویه (M:N):** این فرآیند ضروری است زیرا ارتباط بین فاکتور و پرداخت همیشه یک به یک (1:1) نیست:
    * **چند به یک (N:1):** یک مشتری ممکن است ۳ فاکتور باز را با ۱ چک پرداخت کند.
    * **یک به چند (1:N):** یک مشتری ممکن است ۱ فاکتور را در ۳ قسط پرداخت کند.
    * **چند به چند (M:N):** یک مشتری ممکن است ۲ فاکتور و بخشی از فاکتور سوم را با ۱ چک و ۱ واریز نقدی (که قبلاً علی‌الحساب پرداخت کرده) تسویه کند.

---

## ۲. فرم: میزکار تسویه حساب (Settlement Workbench)

این فرم یک ابزار تعاملی است که به کاربر (حسابدار) اجازه می‌دهد آیتم‌های باز یک طرف حساب را مشاهده و با هم تسویه کند.

**مسیر:**
`خزانه‌داری / عملیات / تسویه حساب مشتریان`
`خزانه‌داری / عملیات / تسویه حساب تأمین‌کنندگان`

### رابط کاربری (UX)

این فرم معمولاً به صورت زیر طراحی می‌شود:

1.  **انتخاب طرف حساب:** کاربر ابتدا مشتری یا تأمین‌کننده مورد نظر را انتخاب می‌کند.
2.  **نمایش دو ستونی:** سیستم تمامی آیتم‌های باز (Open Items) آن شخص را در دو ستون نمایش می‌دهد:

    * **ستون ۱: بدهی‌ها (Invoices / Debits):**
        * لیست تمام فاکتورهای فروش (برای مشتری) یا فاکتورهای خرید (برای تأمین‌کننده) که هنوز تسویه نشده‌اند.
        * شامل: شماره فاکتور، تاریخ، مبلغ کل، مبلغ باقیمانده.

    * **ستون ۲: بستانکاری‌ها (Payments / Credits):**
        * لیست تمام پرداخت‌های «علی‌الحساب».
        * پیش‌پرداخت‌های مرتبط.
        * برگشت از فروش‌ها (Credit Memos).
        * شامل: شماره سند پرداخت، تاریخ، مبلغ کل، مبلغ باقیمانده قابل تخصیص.

3.  **فرآیند تسویه (Matching):**
    * کاربر آیتم‌های مورد نظر از هر دو ستون را انتخاب (تیک) می‌کند.
    * *مثال:* انتخاب فاکتور ۱ (مبلغ ۱۰۰) و فاکتور ۲ (مبلغ ۵۰) از ستون ۱؛ و انتخاب پرداخت علی‌الحساب (مبلغ ۱۲۰) و پرداخت جدید (مبلغ ۳۰) از ستون ۲.
    * مجموع بدهی انتخاب شده = ۱۵۰
    * مجموع بستانکاری انتخاب شده = ۱۵۰

4.  **دکمه «تسویه» (Settle):**
    * کاربر دکمه تسویه را می‌زند.
    * سیستم بررسی می‌کند که مجموع دو طرف برابر باشد (یا در صورت تسویه جزئی، منطق آن رعایت شود).
    * سیستم وضعیت فاکتورها و پرداخت‌های انتخاب شده را به «تسویه شده» (Cleared) تغییر می‌دهد و رکوردهای ارتباطی (Settlement Line) را ایجاد می‌کند.

---

## ۳. تسویه خودکار (Automatic Settlement)

برای سادگی، سیستم می‌تواند یک دکمه «تسویه خودکار» نیز داشته باشد که بر اساس منطق FIFO (اولین فاکتور با اولین پرداخت) یا بر اساس شماره ارجاع یکسان، آیتم‌ها را به صورت خودکار تسویه کند.