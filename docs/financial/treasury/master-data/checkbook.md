# دسته چک‌ها (Checkbooks)

## ۱. هدف و مفهوم

در سیستم مالی تابان، موجودیت «دسته چک» نماینده یک دسته چک فیزیکی است که توسط بانک به یکی از **حساب‌های بانکی** شرکت تخصیص داده شده است.

هدف اصلی این ماژول، ایجاد یک **مرجع واحد و قابل ردیابی (Traceable)** برای مدیریت تمام برگه‌های چک از لحظه دریافت از بانک تا زمان مصرف (صدور، پاس شدن، ابطال) است. این فرآیند برای کنترل داخلی، جلوگیری از صدور چک با شماره تکراری، و مدیریت دقیق نقدینگی خروجی، حیاتی است.

  * **اهمیت در ایران:** با توجه به الزامات **سامانه صیاد**، ردیابی دقیق هر برگ چک و شناسه صیادی آن از اهمیت بالایی برخوردار است. این ماژول پایه و اساس تمام عملیات پرداختنی از طریق چک صیادی در سیستم است.
  * **ارتباط کلیدی:** هر «دسته چک» (Checkbook) الزاماً به یک «حساب بانکی» (Bank Account) که قبلاً در سیستم تعریف شده، متصل می‌شود.

-----

## ۲. پیش‌نیازها

قبل از تعریف یک دسته چک جدید، اطمینان حاصل کنید که:

1.  **حساب بانکی مربوطه:** حساب بانکی (از نوع **جاری**) که دسته چک به آن تعلق دارد، قبلاً در ماژول `خزانه‌داری / تعاریف پایه / حساب‌های بانکی` با تمام جزئیات (شعبه، شماره حساب و...) تعریف شده باشد.

-----

## ۳. گام اول: فرم تعریف دسته چک (Checkbook Definition)

این فرم، اطلاعات «سربرگ» (Header) دسته چک را ثبت می‌کند. پس از ذخیره این فرم، سیستم به‌طور خودکار برگه‌های چک را ایجاد خواهد کرد.

**مسیر:**
`خزانه‌داری / تعاریف پایه / دسته چک‌ها`

### فیلدهای اطلاعاتی فرم

| نام فیلد | نوع داده | اجباری | توضیح و مثال |
| :--- | :--- | :--- | :--- |
| **حساب بانکی (Bank Account)** | لیست انتخابی (Lookup) | بله | حسابی که این دسته چک به آن تعلق دارد.<br> **مثال:** `110-810-1234567-1 (جاری - بانک ملت شعبه مرکزی)` |
| **عنوان دسته چک (Name)** | متنی | بله | یک نام توصیفی برای شناسایی آسان‌تر این دسته چک.<br> **مثال:** `دسته چک 50 برگی صیادی (ملت) - بهار 1403` |
| **سریال شروع (Start Serial)** | عددی/متنی | بله | شماره سریال **اولین** برگ چک در این دسته فیزیکی.<br> **مثال:** `123401` |
| **سریال پایان (End Serial)** | عددی/متنی | بله | شماره سریال **آخرین** برگ چک در این دسته فیزیکی.<br> **مثال:** `123450` |
| **تعداد برگ (Leaf Count)** | عددی | خودکار (ReadOnly) | به صورت خودکار محاسبه می‌شود: (سریال پایان - سریال شروع) + 1<br> **مثال:** `50` |
| **پیشوند سریال (Serial Prefix)** | متنی | خیر | اگر شماره سریال‌های چاپی روی برگه‌ها دارای بخش ثابت در **ابتدا** هستند.<br> **مثال:** `الف/` (نتیجه: `الف/123401`) |
| **پسوند سریال (Serial Suffix)** | متنی | خیر | اگر شماره سریال‌های چاپی روی برگه‌ها دارای بخش ثابت در **انتها** هستند.<br> **مثال:** `/980` (کد شعبه) (نتیجه: `123401/980`) |
| **تاریخ دریافت (Received Date)** | تاریخ (Date Picker) | بله | تاریخی که دسته چک فیزیکی از بانک تحویل گرفته شد.<br> **مثال:** `1403/01/20` |
| **وضعیت دسته چک (Status)** | لیست انتخابی | بله | وضعیت کلی دسته چک را مشخص می‌کند (پیش‌فرض: فعال).<br> **مثال:** `فعال` |

### وضعیت‌های دسته چک (Checkbook Status)

  * **فعال (Active):** پیش‌فرض. دسته چک آماده استفاده و صدور برگه‌های چک است.
  * **مسدود (Blocked):** به دلایل مدیریتی یا احتیاطی (مثلاً اعلام مفقودی بخشی از برگه‌ها)، به طور موقت جلوی استفاده از برگه‌های *جدید* این دسته چک گرفته می‌شود.
  * **تمام شده (Finished):** **(وضعیت سیستمی)** این وضعیت نباید دستی انتخاب شود. زمانی که *آخرین* برگ چک موجود در این دسته از وضعیت «خام» خارج شود (صادر یا باطل گردد)، سیستم به طور خودکار وضعیت دسته چک را «تمام شده» تنظیم می‌کند.
  * **باطل شده (Voided):** کل دسته چک قبل از استفاده یا در حین استفاده مفقود شده یا به طور کامل توسط بانک باطل اعلام شده است.

-----

## ۴. گام دوم: ایجاد و تکمیل برگه‌های چک (Check Leaves)

این بخش مهم‌ترین بخش فرآیند است و در دو مرحله (یکی خودکار و یکی دستی توسط کاربر) انجام می‌شود.

### مرحله ۱: ایجاد خودکار برگه‌ها (توسط سیستم)

> **فرآیند:** به محض ذخیره فرم «تعریف دسته چک» (گام ۳)، سیستم یک حلقه (Loop) از «سریال شروع» تا «سریال پایان» اجرا می‌کند و به «تعداد برگ» (مثلاً ۵۰ عدد)، رکوردهای مجزای «برگه‌ چک» (Check Leaf) در وضعیت اولیه **«خام» (Unused)** ایجاد می‌کند.

### مرحله ۲: ورود شناسه‌های صیادی (توسط کاربر)

> **اخطار مهم:** یک دسته چک تا زمانی که شناسه‌های صیادی ۱۶ رقمی منحصربه‌فرد هر برگ در آن ثبت نشده باشد، **قابل استفاده نیست**.

**گردش کار پیشنهادی سیستم:**

1.  پس از ذخیره موفقیت‌آمیز فرم «دسته چک»، سیستم کاربر را مستقیماً به لیستی از برگه‌های چک «خام» که به تازگی ایجاد شده‌اند، هدایت می‌کند.
2.  این لیست باید شامل ستون «شناسه صیادی» (SayadCode) باشد که در ابتدا برای همه برگه‌ها خالی است.
3.  کاربر **باید** قبل از هرگونه استفاده از این دسته چک، برگه‌های فیزیکی چک را برداشته و شناسه ۱۶ رقمی صیادی چاپ شده روی هر برگ را در فیلد مربوط به همان شماره سریال در سیستم وارد کند. (قابلیت ویرایش گروهی یا Edit-in-Grid در اینجا بسیار مفید است).
4.  دسته چک تنها زمانی واقعاً «فعال» و قابل استفاده برای صدور چک تلقی می‌شود که برگه‌های آن دارای شناسه صیادی باشند.

-----

## ۵. موجودیت «برگ چک» (Check Leaf) و چرخه حیات آن

هر رکوردی که در گام ۴ ایجاد می‌شود، یک «برگ چک» است که چرخه حیات خود را طی می‌کند.

### فیلدهای اصلی برگ چک (Check Leaf Properties)

| فارسی | English | توضیح |
| :--- | :--- | :--- |
| **شماره سریال (SerialNumber)** | `SerialNumber` | شماره منحصربه‌فرد برگ (مثلاً `123401`). |
| **شناسه صیادی (SayadCode)** | `SayadCode` | **اجباری.** شناسه ۱۶ رقمی چاپی روی برگ چک. بدون این شناسه، برگ «خام» قابل صدور نیست. |
| **وضعیت برگ چک (Status)** | `CheckLeafStatus` | وضعیت فعلی برگ (خام، صادر شده، پاس شده...). (جزئیات در ادامه) |
| **تاریخ صدور (IssueDate)** | `IssueDate` | `Null` است تا زمانی که چک صادر شود. در لحظه صدور (اتصال به سند پرداخت) ثبت می‌شود. |
| **تاریخ سررسید (DueDate)** | `DueDate` | `Null` است تا زمانی که چک صادر شود. در لحظه صدور **اجباری** می‌شود. |
| **مبلغ چک (Amount)** | `Amount` | `Null` است تا زمانی که چک صادر شود. |
| **دریافت‌کننده (Payee)** | `Payee` | `Null` است تا زمانی که چک صادر شود. (لینک به موجودیت اشخاص/ذینفعان) |
| **توضیحات (Description)** | `Description` | یادداشت اختیاری (مثلاً علت ابطال یا جزئیات صدور). |
| **تاریخچه وضعیت (StatusHistory)** | (Link) | (پیشنهاد) لینکی به تاریخچه کامل تغییرات وضعیت این برگ، شامل کاربر، تاریخ و علت. |

### چرخه حیات وضعیت برگ چک (Check Leaf Status Lifecycle)

وضعیت‌ها صرفاً یک لیست نیستند، بلکه یک فرآیند مشخص را طی می‌کنند.

**۱. وضعیت اولیه:**

  * **خام (Unused):** برگ چک تازه توسط سیستم ایجاد شده، شناسه صیادی آن وارد شده و آماده صدور در «سند پرداخت» است.

**۲. مسیر ابطال (قبل از صدور):**

  * `خام`  **باطل شده (Voided):**
      * **علت:** برگ چک قبل از صدور مفقود شده، در هنگام چاپ توسط پرینتر خراب شده، یا به هر دلیل دیگری از رده خارج می‌شود.
      * **الزام:** سیستم باید هنگام تغییر وضعیت به «باطل شده»، کاربر را ملزم به ثبت «علت ابطال» کند.

**۳. مسیر صدور و نقد شدن (مسیر اصلی):**

1.  **صادر شده (Issued):**
      * **رویداد:** کاربر در فرم «سند پرداخت» (Payment Voucher) این برگ چک را برای پرداخت انتخاب می‌کند.
      * **تغییرات:** فیلدهای `تاریخ صدور`، `تاریخ سررسید`، `مبلغ` و `دریافت‌کننده` در این مرحله پر می‌شوند.
2.  **ثبت شده در صیاد (Registered):**
      * **رویداد:** (پس از صدور) کاربر تأیید می‌کند که این چک در سامانه صیاد بانک ثبت شده است.
3.  **منتظر تأیید ذی‌نفع (Pending Payee Confirmation):**
      * **رویداد:** وضعیت قانونی طبق سامانه صیاد.
4.  **تأیید شده (Confirmed):**
      * **رویداد:** ذی‌نفع چک را در سامانه صیاد تأیید کرده است. چک اکنون اعتبار قانونی کامل دارد.
5.  **تحویل شده (Delivered):**
      * **رویداد:** (اختیاری اما مفید) واحد مالی، فیزیک چک را به ذی‌نفع تحویل داده و تأییدیه گرفته است.
6.  **پاس شده (Cleared):**
      * **رویداد:** در زمان «صورت مغایرت بانکی» (Reconciliation)، چک در لیست آیتم‌های برداشت شده از حساب بانک ظاهر شده و وضعیت آن در تابان به‌روز می‌شود.

**۴. مسیرهای برگشتی:**

  * **برگشت خورده (Returned):**
      * **رویداد:** پس از مراجعه ذی‌نفع به بانک، چک به دلیل عدم موجودی یا دلایل دیگر توسط بانک برگشت خورده است.
  * **عودت شده (Returned from Payee):**
      * **رویداد:** ذی‌نفع به هر دلیلی (قبل یا بعد از تأیید صیادی، مثلاً لغو معامله) فیزیک چک را به شرکت عودت داده است. این برگ چک باید «باطل» شود.

-----

##  ۶. قوانین کلیدی و اتوماسیون (Business Rules)

1.  **اجباری بودن سررسید:** فیلد `تاریخ سررسید` (DueDate) زمانی که وضعیت برگ «خام» است، باید `Null` و غیرفعال باشد. اما در لحظه «صدور» (تغییر وضعیت به `Issued`)، پر کردن آن باید **اجباری** شود.
2.  **تاریخچه وضعیت:** هرگونه تغییر در `CheckLeafStatus` (به خصوص `Voided`) باید در یک تاریخچه (Audit Log) ثبت شود: *وضعیت قبلی، وضعیت جدید، تاریخ، کاربر، و فیلد اجباری «علت» (Reason)*.
۳.  **منحصربه‌فردی شناسه صیادی:** سیستم باید در سطح پایگاه داده (Database constraint) اطمینان حاصل کند که هیچ دو برگ چکی (حتی از دسته چک‌های مختلف) نمی‌توانند «شناسه صیادی» یکسان داشته باشند.