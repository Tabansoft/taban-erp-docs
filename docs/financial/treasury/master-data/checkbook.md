# دسته چک‌ها (Checkbooks)

## ۱. مقدمه: چرا مدیریت دسته چک حیاتی است؟

در حسابداری سنتی، چک‌ها فقط زمانی ثبت می‌شدند که صادر می‌شدند. اما در ERP تابان، ما مدیریت چک را از **لحظه تحویل دسته چک خام از بانک** آغاز می‌کنیم.

**چرا این ماژول وجود دارد؟**

1.  **کنترل تسلسل (Sequence Control):** تا مدیر مالی مطمئن شود هیچ برگ چکی بدون اطلاع او از دفتر خارج نشده است.
2.  **الزام قانونی صیاد:** هر برگ چک دارای یک «شناسه صیادی ۱۶ رقمی» است که باید قبل از صدور در سیستم ثبت شود.
3.  **جلوگیری از تقلب:** سیستم اجازه نمی‌دهد یک شماره چک دو بار صادر شود یا چکی که اعلام مفقودی شده، نقد شود.

> **معماری داده (Data Hierarchy):**
> `حساب بانکی` (والد) ---\> `دسته چک` (فرزند) ---\> `برگ چک` (نوه)
> *هر حساب می‌تواند چندین دسته چک داشته باشد، و هر دسته چک شامل چندین برگ است.*

-----

## ۲. راهنمای تکمیل فرم تعریف دسته چک (Header)

**مسیر دسترسی:** `خزانه‌داری > تعاریف پایه > دسته چک‌ها`

این فرم فقط یک‌بار (زمانی که دسته چک فیزیکی را از بانک تحویل می‌گیرید) تکمیل می‌شود.

| عنوان فیلد            | نام فنی (Technical) | نوع داده   | راهنمای تکمیل و منطق سیستم                                                                                                                            |
| :-------------------- | :------------------ | :--------- | :---------------------------------------------------------------------------------------------------------------------------------------------------- |
| **حساب بانکی**        | `BankAccountID`     | FK         | این دسته چک متعلق به کدام حساب است؟ <br> **فیلتر هوشمند:** لیست فقط حساب‌های نوع **«جاری» (Current)** را نمایش می‌دهد.                                  |
| **عنوان دسته چک**     | `Name`              | String     | نامی برای بایگانی. <br> *مثال:* `دسته چک ۵۰ برگی صیادی (ملت) - سری A`                                                                                 |
| **تاریخ تحویل**       | `ReceiveDate`       | Date       | تاریخی که دسته چک فیزیکاً به شرکت رسیده است.                                                                                                           |
| **سریال شروع**        | `StartSerial`       | String/Int | شماره چاپی روی **اولین** برگ چک (مثلاً `۸۰۵۱۰۰`).                                                                                                      |
| **تعداد برگ**         | `LeafCount`         | Integer    | تعداد کل برگ‌ها (مثلاً `۵۰` یا `۱۰۰`).                                                                                                                  |
| **سریال پایان**       | `EndSerial`         | Calculated | **(غیرقابل ویرایش)** سیستم خودکار محاسبه می‌کند: <br> `StartSerial + LeafCount - 1`                                                                    |
| **پیشوند سریال**      | `SerialPrefix`      | String     | حروف ثابت قبل از شماره (مثلاً `۱۱۰/`). <br> *کاربرد:* در چاپ چک، این پیشوند کنار شماره سریال چاپ می‌شود.                                                |
| **شناسه صیاد پیش‌فرض** | `DefaultSayadID`    | String     | (اختیاری) اگر بانک الگوی خاصی دارد (که معمولاً ندارد)، اینجا وارد می‌شود.                                                                               |
| **وضعیت**             | `Status`            | Enum       | **فعال:** آماده صدور. <br> **مسدود:** استفاده ممنوع (مفقودی/سرقت). <br> **تمام شده:** وقتی تمام برگه‌ها مصرف شدند، سیستم خودکار این وضعیت را ست می‌کند. |

-----

## ۳. عملیات حیاتی: تولید و مدیریت برگه‌ها (Leaves Management)

پس از تعریف هدر دسته چک، سیستم به صورت خودکار ۵۰ یا ۱۰۰ رکورد (برگ چک) در دیتابیس ایجاد می‌کند. اکنون نوبت مهم‌ترین کار است: **ثبت شناسه صیادی**.

### چالش ورود اطلاعات (Data Entry Pain Point)

وارد کردن ۵۰ عدد شناسه ۱۶ رقمی (مجموعاً ۸۰۰ رقم\!) به صورت دستی، کابوس کاربران است. سیستم تابان ۳ راهکار دارد:

1.  **روش دستی (Grid View):** برای اصلاحات جزئی.
2.  **اتصال به بارکدخوان (Scanner):** روی فیلد شناسه کلیک کنید و QR Code روی چک را اسکن کنید.
3.  **ایمپورت اکسل (Excel Import):** فایل اکسلی که از اینترنت بانک می‌گیرید (شامل شماره سریال و شناسه صیاد) را بارگذاری کنید. سیستم بر اساس «شماره سریال» مچ کرده و شناسه‌ها را پر می‌کند.

> **قانون سخت‌گیرانه سیستم:** تا زمانی که شناسه صیادی یک برگ چک وارد نشده باشد، آن برگ در فرم «سند پرداخت» نمایش داده نمی‌شود.

-----

## ۴. چرخه حیات یک برگ چک (Check Leaf Lifecycle)

هر برگ چک در سیستم یک موجودیت زنده است که وضعیت‌های زیر را طی می‌کند:

| وضعیت (فارسی)            | نام فنی (State) | معنی و کاربرد                                                                                                                                   |
| :----------------------- | :-------------- | :---------------------------------------------------------------------------------------------------------------------------------------------- |
| **۱. خام (سفید)**        | `Unused`        | چک در دسته چک است، شناسه صیاد دارد اما هنوز صادر نشده (مبلغ و تاریخ ندارد).                                                                     |
| **۲. باطل شده (فیزیکی)** | `Voided`        | **(قبل از خروج از شرکت)** چک در پرینتر گیر کرده، روی آن قهوه ریخته یا حین نوشتن خط خورده است. لاشه هست اما اعتبار ندارد.                        |
| **۳. صادر شده**          | `Issued`        | چک در «سند پرداخت» استفاده شده، امضا شده و به ذینفع تحویل شده است.                                                                              |
| **۴. پاس شده**           | `Cleared`       | مبلغ چک از حساب کسر شده (توسط مغایرت‌گیری تایید شده).                                                                                            |
| **۵. استرداد شده**       | `Returned`      | **(بعد از خروج)** چک صادر شده بود، اما مشتری قرارداد را لغو کرد و چک را پس داد. این چک دیگر «خام» نیست (چون رویش نوشته شده) و باید بایگانی شود. |

-----

## ۵. سناریوهای عملیاتی و مثال‌ها

### سناریو ۱: چک خراب شده در پرینتر (The Printer Jam)

**داستان:** حسابدار دستور چاپ چک شماره `805105` را می‌دهد. کاغذ در پرینتر جمع می‌شود و چک پاره می‌شود.

1.  کاربر به فرم «مدیریت دسته چک» می‌رود.
2.  تب «برگه‌های چک» را باز می‌کند.
3.  سریال `805105` را پیدا کرده، راست کلیک و گزینه **«ابطال (Void)»** را می‌زند.
4.  **سیستم:** وضعیت را به `Voided` تغییر می‌دهد و از کاربر "علت ابطال" می‌خواهد (تایپ می‌کند: خرابی پرینتر).
5.  **نتیجه:** در صدور چک بعدی، سیستم خودکار شماره `805106` را پیشنهاد می‌دهد.

### سناریو ۲: گم شدن دسته چک (The Lost Checkbook)

**داستان:** کیف دستی مدیر مالی سرقت شده و دسته چک بانک ملی (سری B) داخل آن بوده است.

1.  مدیر سیستم فوری وارد فرم می‌شود.
2.  دسته چک مربوطه را پیدا کرده و وضعیت کلی آن را به **«مسدود شده» (Blocked)** تغییر می‌دهد.
3.  **نتیجه:** تمام برگه‌های "خام" باقی‌مانده قفل می‌شوند. هیچ کاربری در هیچ شعبه‌ای نمی‌تواند از این دسته چک استفاده کند.

### سناریو ۳: چک سفید امضا (Blank Check)

**داستان:** مدیرعامل می‌خواهد به سفر برود و یک چک سفید امضا (بدون مبلغ) به مدیر مالی می‌دهد.

  * **راهکار سیستم:** در سیستم‌های مالی استاندارد، ثبت چک بدون مبلغ ممنوع است.
  * **توصیه:** یک سند پرداخت موقت با مبلغ تقریبی (یا ۱ ریال) به نام "صندوق امانات" ثبت کنید تا وضعیت چک از "خام" خارج شود و بدانید این برگ چک کجاست.

-----

## ۶. کنترل‌های هوشمند سیستم (Validations)

1.  **جلوگیری از تکرار صیاد:** سیستم کل دیتابیس را می‌گردد تا مطمئن شود شناسه ۱۶ رقمی این چک، قبلاً در هیچ دسته چک دیگری (حتی بانک‌های دیگر) ثبت نشده باشد.
2.  **کنترل توالی تاریخ:** اگر چک شماره `105` را به تاریخ امروز صادر کنید، سیستم هشدار می‌دهد اگر بخواهید چک شماره `104` را به تاریخ فردا صادر کنید (اگر تنظیمات "رعایت توالی" فعال باشد).
3.  **همخوانی حساب:** در سند پرداخت، اگر حساب "بانک ملت" را انتخاب کنید، سیستم فقط برگه‌های دسته چک "بانک ملت" را می‌آورد.

-----

## ۷. پرسش‌های متداول (FAQ)

**س: آیا می‌توانم یک دسته چک را حذف کنم؟**

**پ:** اگر هیچ‌کدام از برگه‌های آن استفاده نشده باشد، بله. اما اگر حتی یک برگ صادر شده باشد، خیر. فقط می‌توانید آن را "غیرفعال" کنید.

**س: اگر شناسه صیادی را اشتباه وارد کرده باشم و چک را صادر کرده باشم، چه کنم؟**

**پ:** فاجعه است\! چون مغایرت بانکی پیش می‌آید.

1.  باید سند پرداخت مربوطه را ویرایش کنید و چک را از آن حذف کنید (چک به حالت خام برمی‌گردد).
2.  به فرم دسته چک بروید، شناسه صیاد را اصلاح کنید.
3.  مجدداً چک را در سند پرداخت انتخاب کنید.

**س: تکلیف چک‌های قدیمی (غیر صیادی) چیست؟**

**پ:** سیستم فیلد "شناسه صیاد" را اجباری کرده است؟ در تنظیمات می‌توان برای دسته چک‌های قدیمی (قبل از سال ۱۴۰۰) تیک "چک صیادی است" را برداشت تا سیستم شناسه نخواهد.

**س: آیا سیستم به سامانه صیاد بانک مرکزی وصل است؟**

**پ:** (بسته به ماژول خریداری شده) بله، اگر ماژول API بانکی را داشته باشید، با زدن دکمه "استعلام"، وضعیت چک (سفید/زرد/قرمز) را از بانک مرکزی می‌گیرد و نمایش می‌دهد.

-----

## ۸. گزارش‌های کلیدی

  * **گزارش برگه‌های خام:** لیست تمام شماره چک‌های سفید موجود در گاوصندوق (برای انبارگردانی).
  * **گزارش ضایعات چک:** لیستی از چک‌های باطل شده (Void) به همراه علت و نام کاربری که آن را باطل کرده.
  * **کاردکس دسته چک:** نمای گرافیکی که نشان می‌دهد از یک دسته چک ۵۰ برگی، چند تا صادر شده، چند تا پاس شده و چند تا مانده است.