# دفاتر استهلاک (Depreciation Books)

**مسیر دسترسی:** `دارایی ثابت > پیکربندی > دفاتر استهلاک`
**نام فنی:** `DepreciationBook`

## ۱. مقدمه و فلسفه وجودی

در دنیای واقعی مدیریت مالی، همیشه تضادی بین **«قانون»** و **«واقعیت»** وجود دارد.

  * **نگاه اداره مالیات (قانون):** طبق ماده ۱۴۹، عمر مفید یک کامپیوتر ۳ سال است. بعد از ۳ سال، هزینه استهلاک آن را به عنوان "هزینه قابل قبول مالیاتی" نمی‌پذیرد.
  * **نگاه مدیر کارخانه (واقعیت):** ما از این کامپیوتر ۵ سال استفاده می‌کنیم. اگر در گزارش سود و زیان داخلی، عمرش را ۳ سال بزنیم، در سال‌های ۴ و ۵ سودمان به طور کاذب بالا می‌رود (چون هزینه استهلاک نداریم)، در حالی که دستگاه هنوز دارد کار می‌کند و فرسوده می‌شود.

**راه حل ERP تابان چیست؟**
استفاده از **معماری چند دفتری (Multi-Book Architecture)**.
ما برای هر دارایی، چند دفتر استهلاک موازی باز می‌کنیم. مثل این است که دو حسابدار مختلف، هم‌زمان و بدون اطلاع از هم، دارند برای یک دستگاه محاسبات انجام می‌دهند.

### انواع رایج دفاتر:

1.  **دفتر مالیاتی/قانونی (Tax/Legal Book):** *اجباری.* محاسبات دقیقاً طبق قوانین کشور (استاندارد ۱۴۹ ایران). این دفتر مبنای صدور سند حسابداری و پرداخت مالیات است.
2.  **دفتر عملیاتی/داخلی (Corporate/Internal Book):** *اختیاری.* محاسبات طبق واقعیت فنی و سیاست‌های مدیریت. مبنای گزارش‌گیری داخلی و تحلیل سودآوری (ROI).
3.  **دفتر IFRS (بین‌المللی):** *اختیاری.* برای شرکت‌هایی که شریک خارجی دارند و باید طبق استاندارد جهانی گزارش دهند.

-----

## ۲. منطق عملکردی (Functional Logic)

در این ماژول، تعریف می‌کنیم که "قوانین بازی" برای هر دفتر چیست.

### لایه صدور سند (Posting Layer) - حیاتی‌ترین مفهوم

وقتی ما دو دفتر داریم (مالیاتی و داخلی)، آیا هر دو باید سند حسابداری صادر کنند؟

  * **خیر\!** اگر هر دو سند بزنند، هزینه استهلاک در ترازنامه "دو برابر" می‌شود.

سیستم تابان باید سه حالت را پشتیبانی کند:

1.  **پست‌کننده به دفتر کل (GL Posting):** فقط دفتر "مالیاتی" این تیک را دارد. اسناد این دفتر وارد ترازنامه اصلی می‌شود.
2.  **فقط گزارش‌گیری (Reporting Only):** دفتر "داخلی" معمولاً این‌طور است. سند صادر نمی‌کند، فقط در گزارشات مدیریتی دیده می‌شود.
3.  **پست‌کننده به لایه دوم (Custom Layer Posting):** (پیشرفته) سند صادر می‌کند، اما نه در دفتر کل اصلی، بلکه در یک "لایه تحلیلی" جداگانه برای مقاصد خاص.

-----

## ۳. بخش‌های عملیاتی فرم (Form Details)

| عنوان فیلد | شرح و منطق بیزینسی |
| :--- | :--- |
| **کد دفتر** | شناسه یونیک (مثلاً `TAX-BOOK` یا `CORP-BOOK`). |
| **شرح دفتر** | عنوان نمایشی (مثلاً: دفتر قانونی ماده ۱۴۹). |
| **آیا سند حسابداری صادر کند؟ (Post to GL)** | **بسیار مهم.** اگر `Bale` باشد، موتور استهلاک برای این دفتر سند مالی تولید می‌کند. معمولاً فقط برای یک دفتر فعال است. |
| **تقویم مالی (Fiscal Calendar)** | تعیین تقویم محاسبات (شمسی/میلادی). این قابلیت برای هلدینگ‌های چندملیتی حیاتی است. |
| **گردش تا ارزش اسقاط** | تنظیم می‌کند که آیا استهلاک تا رسیدن به صفر ادامه یابد یا تا رسیدن به "ارزش اسقاط". |
| **گرد کردن (Rounding)** | مبالغ استهلاک محاسبه شده چگونه گرد شوند؟ (مثلاً رند کردن به ۱ ریال یا ۱۰۰۰ ریال). |

-----

## ۴. سناریوهای کاربردی (Use Cases)

### سناریوی ۱: استاندارد ایران (دو دفتری)

اکثر شرکت‌های بورسی و بزرگ ایرانی به این مدل نیاز دارند.

  * **دفتر A (دفتر مالیاتی):**
      * **قانون:** ماده ۱۴۹ ق.م.م.
      * **روش:** نزولی (طبق جدول دارایی).
      * **عمر مفید:** ۳ سال.
      * **صدور سند:** ✅ بله (چون دفاتر قانونی باید طبق این باشد).
  * **دفتر B (دفتر مدیریتی):**
      * **قانون:** سیاست داخلی شرکت.
      * **روش:** خط مستقیم (واقعی).
      * **عمر مفید:** ۵ سال.
      * **صدور سند:** ❌ خیر (فقط برای گزارش‌گیری در داشبورد مدیرعامل).

> **نتیجه:** مدیر مالی فرم اظهارنامه مالیاتی را از دفتر A می‌گیرد، اما مدیرعامل سود واقعی خط تولید را از دفتر B می‌بیند.

### سناریوی ۲: بخش دولتی (تک دفتری)

سازمان‌های دولتی معمولاً نیازی به تحلیل‌های پیچیده سودآوری ندارند و ملزم به رعایت "نظام نوین مالی" هستند.

  * **دفتر A (نظام نوین):**
      * **قانون:** بخشنامه‌های وزارت دارایی.
      * **صدور سند:** ✅ بله.
      * **نکته:** در این حالت فقط یک دفتر تعریف می‌شود.

-----

## ۵. تعامل با سایر بخش‌ها (Integration)

1.  **در فرم "طبقه دارایی" (Asset Class):**

      * ما برای هر طبقه، باید روش استهلاک را برای **تک‌تک دفترها** تعیین کنیم.
      * *مثال:* در طبقه "خودرو"، برای دفتر مالیاتی روش "نزولی" و برای دفتر داخلی روش "خط مستقیم" تنظیم می‌شود.

2.  **در فرم "کارت دارایی" (Asset Master):**

      * وقتی دارایی جدید ثبت می‌شود، تب "دفاتر استهلاک" به صورت خودکار بر اساس تنظیمات طبقه پر می‌شود.
      * کاربر می‌تواند برای یک دارایی خاص، تنظیمات یک دفتر را تغییر دهد (مثلاً عمر مفید دفتر داخلی را کم کند).

3.  **در موتور استهلاک (Depreciation Run):**

      * وقتی کاربر دکمه "محاسبه استهلاک دی‌ماه" را می‌زند، سیستم می‌پرسد: *"برای کدام دفتر؟"*
      * اگر دفتر مالیاتی انتخاب شود -\> سند حسابداری صادر می‌شود.
      * اگر دفتر داخلی انتخاب شود -\> فقط جداول گزارش‌گیری بروزرسانی می‌شوند.

-----

## ۶. ملاحظات فنی برای توسعه‌دهندگان (Developer Notes)

### الف) ساختار داده (One-to-Many Relationship)

هر دارایی (`Asset`) یک رابطه یک‌به‌چند با جدول وضعیت دفاتر (`Asset_Book_Status`) دارد.

```sql
TABLE Asset_Book_Status (
    ID INT PK,
    AssetID INT FK,
    BookID INT FK, -- اشاره به دفتر مالیاتی یا داخلی
    
    -- هر دفتر وضعیت مالی مستقل خودش را دارد:
    AcquisitionCost DECIMAL, -- بهای تمام شده (ممکن است در دو دفتر متفاوت باشد!)
    AccumulatedDepr DECIMAL, -- استهلاک انباشته
    NetBookValue DECIMAL,    -- ارزش دفتری
    DeprMethod Enum,         -- روش استهلاک
    LifeYears INT            -- عمر مفید
);
```

> **نکته پیچیده:** چرا `AcquisitionCost` در دفاتر جداست؟
> گاهی طبق استانداردهای IFRS، برخی هزینه‌های نصب جزو بهای تمام شده می‌آیند، اما طبق قوانین مالیاتی ایران خیر. پس حتی "قیمت خرید" هم ممکن است در دو دفتر متفاوت ثبت شود.

### ب) پرفورمنس (Performance)

اگر سازمان ۱۰۰,۰۰۰ دارایی داشته باشد و ۳ دفتر استهلاک، موتور محاسبات باید ۳۰۰,۰۰۰ رکورد را پردازش کند. این فرآیند سنگین است و باید:

1.  در Background Job اجرا شود.
2.  از تراکنش‌های دسته‌ای (Batch Processing) استفاده کند.

-----

## ۷. پرسش‌های متداول (FAQ)

**س: آیا مجبوریم حتماً چند دفتر تعریف کنیم؟**

  * **پاسخ:** خیر. در تنظیمات اولیه (Wizard)، اگر پروفایل "ساده" انتخاب شود، سیستم به طور پیش‌فرض فقط یک دفتر (دفتر اصلی) می‌سازد و کاربر اصلاً متوجه پیچیدگی نمی‌شود. این قابلیت برای شرکت‌های بزرگ است.

**س: اگر در دفتر داخلی سند حسابداری نزنیم، پس فایده‌اش چیست؟**

  * **پاسخ:** فایده‌اش در **«گزارش‌های مقایسه‌ای»** است. شما گزارشی می‌گیرید که نشان می‌دهد: *"سود شرکت طبق قوانین مالیاتی ۱۰ میلیارد است، اما طبق واقعیت عملیاتی (دفتر داخلی) ۱۲ میلیارد است."* این دیدگاه برای هیئت مدیره طلاست.

**س: آیا می‌توانم دفتر داخلی را به تقویم میلادی و دفتر مالیاتی را به شمسی وصل کنم؟**

  * **پاسخ:** بله، این یکی از کاربردهای اصلی ERP تابان برای شرکت‌های خارجی فعال در ایران است. دفتر شمسی برای اداره مالیات ایران و دفتر میلادی برای گزارش‌دهی به شرکت مادر در خارج.