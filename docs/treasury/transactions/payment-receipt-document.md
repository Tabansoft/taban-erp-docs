# اسناد دریافت و پرداخت (Payment/Receipt Documents)

---

## ۱. مفهوم و هدف

این فرم، **قلب تپنده و فرم عملیاتی اصلی** در ماژول خزانه‌داری است. بر اساس این اصل کلیدی طراحی شده است که:

> **اصل طلایی:** هیچ جابجایی وجهی (نقد، چک، یا حواله) در دنیای واقعی نباید اتفاق بیفتد، مگر آنکه یک «سند دریافت و پرداخت» متناظر در ERP تابان برای ردیابی آن ثبت شود.

این سند، موجودیت واحدی است که تمام ورودی‌ها، خروجی‌ها و جابجایی‌های داخلی وجوه نقد سازمان را ثبت می‌کند. این فرم، مسئول مستقیم تغییر موجودی بانک/صندوق و همچنین مبنای اصلی صدور **سند حسابداری خودکار** در دفتر کل (GL) است.

### انواع تراکنش‌های تحت پوشش

این فرم باید سه سناریوی اصلی را از طریق یک فیلد کلیدی به نام **«نوع سند» (Document Type)** مدیریت کند:

1.  **دریافت (Receipt):**
    * **هدف:** ثبت ورود وجه به سازمان.
    * **مثال‌ها:** دریافت چک از مشتری بابت فاکتور فروش، دریافت واریز نقدی بابت پیش‌پرداخت سفارش، دریافت درآمد متفرقه (مثلاً فروش ضایعات).
2.  **پرداخت (Payment):**
    * **هدف:** ثبت خروج وجه از سازمان.
    * **مثال‌ها:** صدور چک برای تأمین‌کننده بابت فاکتور خرید، پرداخت نقدی هزینه‌های مستقیم (مانند پیک)، پرداخت علی‌الحساب به کارمند.
3.  **انتقال (Transfer):**
    * **هدف:** ثبت جابجایی وجه بین دو حساب داخلی شرکت (بدون دخالت طرف حساب خارجی).
    * **مثال‌ها:** انتقال پول از «حساب بانک ملت» به «حساب بانک سامان»، یا انتقال وجه از «بانک» برای «شارژ صندوق تنخواه».

---

## ۲. ملاحظات کلیدی: مدیریت سناریوهای پرداخت

یک سند پرداخت ساده فقط پرداخت یک فاکتور است. اما یک ERP قدرتمند باید سناریوهای پیچیده‌تر را مدیریت کند. این فرم باید سه حالت اصلی ارتباط با طرف حساب را پوشش دهد:

### الف) پرداخت/دریافت بابت فاکتور (Standard)
* **مفهوم:** ساده‌ترین حالت. یک یا چند فاکتور مشخص وجود دارد و این سند برای تسویه (کامل یا بخشی از) آن‌ها صادر می‌شود.
* **نحوه اجرا:** این کار معمولاً در این فرم انجام **نمی‌شود**، بلکه در فرم «تسویه حساب» (Settlement) انجام می‌شود. این فرم فقط پول را دریافت یا پرداخت می‌کند (به بخش ۴، گام ۴ مراجعه کنید).

### ب) پیش‌پرداخت (Prepayment - مرتبط با سفارش)
* **مفهوم:** پرداختی که *قبل* از دریافت کالا/خدمات و *قبل* از صدور فاکتور انجام می‌شود، اما مستقیماً به یک **سفارش (PO/SO)** مشخص مرتبط است.
* **مثال سناریو:**
    * ما یک «سفارش خرید» (PO-1002) برای خرید مواد اولیه از «شرکت فولاد پارس» به مبلغ ۱ میلیارد ریال ثبت می‌کنیم.
    * فولاد پارس برای شروع کار، ۳۰۰ میلیون ریال پیش‌پرداخت می‌خواهد.
    * ما یک «سند پرداخت» (نوع: پرداخت) صادر می‌کنیم و در فیلد **«ارجاع به سفارش»**، کد PO-1002 را انتخاب می‌کنیم.
    * **نتیجه:** این ۳۰۰ میلیون به عنوان یک آیتم باز بستانکار روی PO-1002 می‌نشیند. زمانی که فاکتور نهایی ۱ میلیاردی از فولاد پارس می‌رسد، سیستم به صورت خودکار تشخیص می‌دهد که فقط ۷۰۰ میلیون ریال دیگر قابل پرداخت است.

### ج) علی‌الحساب (On-Account - شناور)
* **مفهوم:** پرداختی که در لحظه ثبت، به هیچ فاکتور یا سفارش *مشخصی* مرتبط نیست. این صرفاً واریز یا دریافت وجه به/از حساب یک طرف حساب است.
* **مثال سناریو:**
    * «شرکت ایران خودرو» (مشتری کلیدی ما) برای ساده‌سازی فرآیند، در ابتدای ماه یک حواله ۵ میلیارد ریالی به حساب ما واریز می‌کند.
    * ما یک «سند دریافت» (نوع: دریافت) به مبلغ ۵ میلیارد ریال به صورت «علی‌الحساب» برای ایران خودرو ثبت می‌کنیم.
    * **نتیجه:** این ۵ میلیارد به عنوان «اعتبار» (Credit) در حساب این مشتری می‌نشیند. طی ماه، ما ۱۰ فاکتور مختلف (مثلاً هر کدام ۲۰۰ میلیون ریال) برای ایران خودرو صادر می‌کنیم. در پایان هفته، حسابدار ما به فرم «تسویه حساب» (Settlement) رفته و آن ۱۰ فاکتور را با استفاده از این اعتبار ۵ میلیاردی تسویه می‌کند، بدون آنکه نیاز به ثبت سند دریافت جدیدی باشد.

### د) پرداخت هزینه مستقیم (Direct Expense - مرتبط با G/L)
* **مفهوم:** پرداختی که اصلاً به ماژول‌های خرید (AP) یا فروش (AR) مرتبط نیست. این پرداخت مستقیماً برای یک «حساب هزینه» در دفتر کل انجام می‌شود.
* **مثال سناریو:**
    * پرداخت هزینه پیک به مبلغ ۵۰۰,۰۰۰ ریال از «صندوق تنخواه».
    * پرداخت قبض برق ماهانه به مبلغ ۱۲,۰۰۰,۰۰۰ ریال از «حساب بانک».
* **نحوه اجرا:** در بخش «طرف حساب» (Partner)، کاربر به جای مشتری یا تأمین‌کننده، مستقیماً **«حساب معین G/L»** (مثلاً `6201010 - هزینه پیک` یا `6105020 - هزینه آب و برق`) را انتخاب می‌کند.

---

## ۳. فرم: سند دریافت و پرداخت (Payment/Receipt Document)

**مسیر:** `خزانه‌داری / عملیات / سند دریافت و پرداخت جدید`

این فرم از یک بخش «سربرگ» (اطلاعات کلی) و یک یا چند «ردیف» (جزئیات روش پرداخت) تشکیل شده است.

### بخش سربرگ (Header)

| نام فیلد               | نوع داده     | اجباری                    | توضیح و مثال‌ها                                                                                                                                                                                                                                                                               |
| :--------------------- | :----------- | :------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **بنگاه اقتصادی**      | انتخابی (FK) | بله                       | بنگاهی که تراکنش مالی را انجام می‌دهد.                                                                                                                                                                                                                                                        |
| **نوع سند**            | انتخابی      | بله                       | **(فیلد کنترلی اصلی)** `دریافت` / `پرداخت` / `انتقال`. (انتخاب این گزینه، رفتار سایر فیلدها را تغییر می‌دهد).                                                                                                                                                                                 |
| **تاریخ سند**          | تاریخ        | بله                       | تاریخ واقعی چک، حواله یا واریز نقدی.                                                                                                                                                                                                                                                         |
| **تاریخ ثبت**          | تاریخ        | بله                       | تاریخ ورود داده در سیستم (معمولاً خودکار = تاریخ روز).                                                                                                                                                                                                                                        |
| **طرف حساب (Partner)** | انتخابی (FK) | (بله، برای دریافت/پرداخت) | **(فیلد هوشمند)** <br> * **اگر پرداخت/دریافت استاندارد بود:** `مشتری` یا `تأمین‌کننده` را انتخاب می‌کنید (مثلاً: «شرکت فولاد پارس»). <br> * **اگر پرداخت هزینه مستقیم بود:** `حساب G/L` را انتخاب می‌کنید (مثلاً: «6201010 - هزینه پیک»). <br> * **اگر انتقال بود:** این فیلد غیرفعال/مخفی می‌شود. |
| **مبلغ کل**            | عددی         | بله                       | مبلغ کل سند. سیستم باید اعتبارسنجی کند که **مجموع ردیف‌ها = مبلغ کل**.                                                                                                                                                                                                                        |
| **شرح سند**            | متنی         | بله                       | توضیح کلی (مثلاً: «پرداخت علی‌الحساب بابت PO-1002»).                                                                                                                                                                                                                                           |
| **ارجاع به سفارش**     | انتخابی (FK) | خیر                       | (فقط برای سناریوی «پیش‌پرداخت») شماره سفارش فروش یا سفارش خرید.                                                                                                                                                                                                                               |

---

### بخش ردیف‌ها (Lines) - (جزئیات روش پرداخت)

کاربر می‌تواند برای یک سند، چندین ردیف اضافه کند. (مثال: پرداخت یک فاکتور ۵۰ میلیونی با ۱۰ میلیون نقد + یک چک ۴۰ میلیونی).

| نام فیلد            | نوع داده     | اجباری                        | توضیح و مثال‌ها                                                        |
| :------------------ | :----------- | :---------------------------- | :-------------------------------------------------------------------- |
| **روش پرداخت**      | انتخابی      | بله                           | `نقد` / `چک` / `حواله (انتقال بانکی)` / `کارت‌خوان (POS)`...           |
| **مبلغ**            | عددی         | بله                           | مبلغ مربوط به این ردیف خاص.                                           |
| **حساب/صندوق مبدأ** | انتخابی (FK) | (بله، برای `پرداخت`/`انتقال`) | حساب بانکی یا صندوقی که پول از آن *خارج* می‌شود. (مثلاً: «بانک ملت»)    |
| **حساب/صندوق مقصد** | انتخابی (FK) | (بله، برای `دریافت`/`انتقال`) | حساب بانکی یا صندوقی که پول به آن *وارد* می‌شود. (مثلاً: «صندوق مرکزی») |
| **شرح ردیف**        | متنی         | خیر                           | توضیحات جزئی (مثلاً: «چک اول از سه قسط»).                              |

---

### بخش ردیف‌ها: فیلدهای پویا بر اساس روش پرداخت

بخش ردیف‌ها باید هوشمند باشد و فیلدهای اضافی را فقط در صورت نیاز نشان دهد:

**الف) اگر روش = `چک` (پرداختی):**

* **حساب بانکی مبدأ:** (اجباری) حسابی که چک از دسته چک آن صادر می‌شود.
* **شماره سریال چک:** (اجباری) **لیست انتخابی** از سریال‌های «خام» ثبت شده در «دسته چک» آن حساب. (کاربر دستی وارد نمی‌کند، بلکه انتخاب می‌کند).
* **تاریخ سررسید:** (اجباری) تاریخ سررسید چک.
* **در وجه:** (متنی) نام گیرنده (معمولاً از سربرگ می‌آید).

**ب) اگر روش = `چک` (دریافتی):**

* **شماره سریال چک:** (متنی) کاربر شماره چک مشتری را **دستی** وارد می‌کند.
* **بانک چک:** (انتخابی FK) بانکی که چک مشتری روی آن است (از لیست بانک‌ها).
* **شعبه و کد:** (متنی) اطلاعات شعبه چک مشتری.
* **تاریخ سررسید:** (اجباری) تاریخ سررسید چک.
* **صاحب حساب:** (متنی) نام صاحب حساب چک (جهت ردیابی).

**ج) اگر روش = `حواله (انتقال بانکی)`:**

* **شماره پیگیری/ارجاع:** (متنی) کد رهگیری انتقال بانکی (ساتنا، پایا، یا شماره رسید).

---

## ۴. فرآیند پس از ثبت (Post-Registration Logic)

پس از اینکه کاربر دکمه «ثبت نهایی» (Post) را فشار می‌دهد، چهار اتفاق کلیدی *باید* در پشت صحنه رخ دهد:

1.  **ثبت نهایی (Posting):**
    * سند قفل می‌شود و دیگر قابل ویرایش نیست (مگر با فرآیند ابطال).
    * وضعیت آن از «پیش‌نویس» (Draft) به «ثبت شده» (Posted) تغییر می‌کند.

2.  **تأثیر بر موجودی (Cash Balance Impact):**
    * **برای نقد/حواله:** موجودی «حساب بانکی» یا «صندوق» انتخاب شده در ردیف‌ها، *بلافاصله* به‌روزرسانی (کم یا زیاد) می‌شود.
    * **برای چک (پرداختی/دریافتی):** موجودی بانک/صندوق *تغییر نمی‌کند*. چک فقط در ماژول «مدیریت چک» (Check Management) با وضعیت «صادر شده» یا «نزد صندوق» ثبت می‌شود. تأثیر واقعی بر موجودی بانک، بعداً در زمان «پاس شدن» یا «وصول» چک رخ خواهد داد.

3.  **ایجاد سند حسابداری (G/L Creation):**
    * مهم‌ترین بخش. سیستم باید *بلافاصله* و *به‌صورت خودکار* یک سند حسابداری در دفتر کل صادر کند. (نمونه‌ها در بخش ۵).

4.  **ایجاد آیتم باز (Open Item Creation):**
    * **اگر سند «علی‌الحساب» یا «پیش‌پرداخت» باشد:** یک «آیتم باز» (Open Item) در حساب طرف حساب (مشتری یا تأمین‌کننده) ایجاد می‌کند. این آیتم نشان‌دهنده اعتبار یا بدهی شناوری است که باید بعداً در فرم **«تسویه حساب» (Settlement Workbench)** با فاکتورها تسویه شود.

---

## ۵. نمونه اسناد حسابداری خودکار (G/L Journals)

این فرم باید اسناد زیر را به صورت خودکار ایجاد کند:

**سناریو ۱: دریافت نقدی علی‌الحساب از مشتری (10 م ریال به صندوق)**

* بدهکار: `11020101 - صندوق مرکزی` (10 م)
* بستانکار: `12010101 - حساب‌های دریافتنی - مشتری الف` (10 م)

**سناریو ۲: پرداخت هزینه مستقیم (پیک) از تنخواه (500 ه.ر)**

* بدهکار: `6201010 - هزینه پیک` (500 ه.ر)
* بستانکار: `11020105 - تنخواه بازرگانی` (500 ه.ر)

**سناریو ۳: صدور چک برای تأمین‌کننده (40 م ریال)**

* بدهکار: `21010101 - حساب‌های پرداختنی - تأمین‌کننده ب` (40 م)
* بستانکار: `21030101 - اسناد پرداختنی` (40 م)
*(توجه: حساب بانک هنوز بستانکار نمی‌شود تا زمان پاس شدن چک)*

**سناریو ۴: انتقال از بانک به صندوق (شارژ تنخواه - 5 م ریال)**

* بدهکار: `11020105 - تنخواه بازرگانی` (5 م)
* بستانکار: `11010001 - بانک ملت` (5 م)