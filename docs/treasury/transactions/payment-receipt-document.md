# مفهوم و فرم: سند دریافت و پرداخت (Payment/Receipt Document)

---

## ۱. مفهوم

این فرم، **اصلی‌ترین فرم عملیاتی** در ماژول خزانه‌داری است. هرگونه جابجایی وجه (ورود، خروج یا انتقال داخلی) *باید* از طریق این سند ثبت شود. این سند به تنهایی موجودی بانک/صندوق را تغییر می‌دهد و مبنای صدور سند حسابداری است.

* **هدف:** ثبت یکپارچه تمامی دریافت‌ها، پرداخت‌ها و انتقالات.
* **انواع تراکنش:**
    1.  **دریافت (Receipt):** دریافت وجه از مشتریان (بابت فاکتور فروش) یا سایر درآمدها.
    2.  **پرداخت (Payment):** پرداخت وجه به تأمین‌کنندگان (بابت فاکتور خرید)، پرداخت هزینه‌ها، یا پرداخت حقوق.
    3.  **انتقال (Transfer):** جابجایی وجه بین دو حساب بانکی داخلی یا بین حساب بانکی و صندوق (مثلاً شارژ تنخواه).

---

## ۲. ملاحظات خاص: پیش‌پرداخت و علی‌الحساب

این سند باید بتواند مفاهیم «پیش‌پرداخت» و «علی‌الحساب» را مدیریت کند:

### پیش‌پرداخت (Prepayment)
* **مفهوم:** پرداختی که *قبل* از دریافت کالا/خدمات و صدور فاکتور انجام می‌شود و مستقیماً به یک **سفارش (PO/SO)** مرتبط است.
* **نحوه اجرا:** در سند پرداخت/دریافت، کاربر باید بتواند شماره «سفارش خرید» یا «سفارش فروش» را انتخاب کند. این پرداخت به عنوان یک «آیتم باز» (Open Item) روی آن سفارش می‌نشیند و در زمان صدور فاکتور نهایی، به صورت خودکار از مبلغ قابل پرداخت کسر می‌گردد.
* **مثال پرداخت:** پرداخت 30% مبلغ به تأمین‌کننده در زمان ثبت سفارش خرید (PO).
* **مثال دریافت:** دریافت 50% مبلغ از مشتری در زمان ثبت سفارش فروش (SO).

### علی‌الحساب (On-Account)
* **مفهوم:** پرداختی که به هیچ فاکتور یا سفارش *مشخصی* در لحظه ثبت، مرتبط نیست. صرفاً مبلغی است که به حساب مشتری/تأمین‌کننده واریز یا از آن دریافت می‌شود.
* **نحوه اجرا:** در سند پرداخت/دریافت، کاربر فقط «طرف حساب» (مشتری/تأمین‌کننده) را انتخاب می‌کند، اما هیچ فاکتور یا سفارشی را به آن لینک نمی‌کند.
* **نتیجه:** این مبلغ به عنوان «بستانکاری» (در پرداخت) یا «بدهکاری» (در دریافت) در حساب آن شخص باقی می‌ماند تا بعداً در فرم «تسویه» (Settlement) با فاکتورهای آینده تسویه شود.

---

## ۳. فرم: سند دریافت و پرداخت (Payment/Receipt Document)

این فرم معمولاً دارای یک «سربرگ» (Header) برای اطلاعات مشترک و یک بخش «ردیف‌ها» (Lines) برای جزئیات روش پرداخت است.

**مسیر:**
`خزانه‌داری / عملیات / سند دریافت و پرداخت جدید`

### بخش سربرگ (Header)

| نام فیلد                            | نوع داده     | اجباری                    | توضیح                                                 |
| :---------------------------------- | :----------- | :------------------------ | :---------------------------------------------------- |
| **بنگاه اقتصادی**                   | انتخابی (FK) | بله                       | بنگاهی که تراکنش را انجام می‌دهد.                      |
| **نوع سند**                         | انتخابی      | بله                       | `دریافت` / `پرداخت` / `انتقال`                        |
| **تاریخ سند**                       | تاریخ        | بله                       | تاریخ واقعی تراکنش.                                   |
| **تاریخ ثبت**                       | تاریخ        | بله                       | تاریخ ورود داده در سیستم (معمولاً خودکار).             |
| **طرف حساب (Partner)**              | انتخابی (FK) | (بله، برای دریافت/پرداخت) | مشتری، تأمین‌کننده، کارمند، یا حساب GL (برای هزینه‌ها). |
| **مبلغ کل**                         | عددی         | بله                       | مبلغ کل سند (باید برابر با مجموع ردیف‌ها باشد).        |
| **شرح سند**                         | متنی         | بله                       | توضیح کلی در مورد تراکنش.                             |
| **ارجاع به سفارش (برای پیش‌پرداخت)** | انتخابی (FK) | خیر                       | شماره سفارش فروش یا سفارش خرید (در صورت پیش‌پرداخت).   |

---

### بخش ردیف‌ها (Lines) - (جزئیات روش پرداخت)

کاربر می‌تواند برای یک سند، چندین ردیف (مثلاً پرداخت بخشی نقد، بخشی چک) اضافه کند.

| نام فیلد            | نوع داده     | اجباری                    | توضیح                                         |
| :------------------ | :----------- | :------------------------ | :-------------------------------------------- |
| **روش پرداخت**      | انتخابی      | بله                       | `نقد` / `چک` / `حواله (انتقال بانکی)`         |
| **مبلغ**            | عددی         | بله                       | مبلغ مربوط به این ردیف.                       |
| **حساب/صندوق مبدأ** | انتخابی (FK) | (بله، برای پرداخت/انتقال) | حساب بانکی یا صندوقی که پول از آن خارج می‌شود. |
| **حساب/صندوق مقصد** | انتخابی (FK) | (بله، برای دریافت/انتقال) | حساب بانکی یا صندوقی که پول به آن وارد می‌شود. |
| **شرح ردیف**        | متنی         | خیر                       | توضیحات جزئی.                                 |

---

### فیلدهای اختصاصی بر اساس روش پرداخت (در ردیف)

**اگر روش = `چک` (پرداختی):**

* **شماره سریال چک:** انتخابی (از لیست سریال‌های «خام» دسته چک).
* **تاریخ سررسید:** تاریخ.
* **در وجه:** متنی (معمولاً نام طرف حساب).

**اگر روش = `چک` (دریافتی):**

* **شماره سریال چک:** متنی (کاربر وارد می‌کند).
* **بانک چک:** انتخابی (FK - از فرم بانک‌ها).
* **شعبه و کد:** متنی.
* **تاریخ سررسید:** تاریخ.
* **صاحب حساب:** متنی.

**اگر روش = `حواله (انتقال بانکی)`:**

* **شماره پیگیری:** متنی (کد رهگیری انتقال).

---

## ۴. فرآیند پس از ثبت

1.  **ثبت نهایی (Post):** پس از تأیید، سند «ثبت نهایی» می‌شود.
2.  **تأثیر موجودی:** موجودی حساب بانکی/صندوق بلافاصله (برای نقد و حواله) یا در سررسید (برای چک) به‌روز می‌شود.
3.  **ایجاد سند حسابداری:** یک سند حسابداری خودکار در GL صادر می‌شود (جزئیات در `Treasury_Integration_Accounting.md`).
4.  **ایجاد آیتم باز:** اگر سند «علی‌الحساب» باشد یا فاکتوری انتخاب نشده باشد، یک آیتم باز در حساب طرف حساب ایجاد می‌کند.